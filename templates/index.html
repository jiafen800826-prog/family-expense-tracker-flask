<!DOCTYPE html>
<html>
<head>
    <title>Family Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <h1>Family Expense Tracker</h1>

    <!-- Add Expense Form -->
    <form method="POST" class="expense-form">
        <input type="number" step="0.01" name="amount" placeholder="Amount" required>
        <input type="text" name="category" placeholder="Category" required>
        <button type="submit">Add Expense</button>
    </form>

    <!-- Total and Delete All -->
    <div class="top-actions">
        <h3>Total Spent: ${{ "%.2f"|format(total) }}</h3>
        <form action="{{ url_for('delete_all') }}">
            <button type="submit" class="delete-all">Delete All Expenses</button>
        </form>
    </div>

    <!-- Expense Table -->
    <table>
        <thead>
            <tr>
                <th>Amount ($)</th>
                <th>Category</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for e in expenses %}
            <tr>
                <td>
                    <input type="number" step="0.01" value="{{ "%.2f"|format(e.amount) }}" class="edit-amount" data-id="{{ e.id }}">
                </td>
                <td>
                    <input type="text" value="{{ e.category }}" class="edit-category" data-id="{{ e.id }}">
                </td>
                <td>
                    <button class="save-btn" data-id="{{ e.id }}">Save</button>
                    <a href="#" class="delete-btn" data-id="{{ e.id }}">X</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Chart -->
    <h2>Spending by Category</h2>
    <canvas id="categoryChart" width="400" height="200"></canvas>
</div>

<!-- Include Chart.js only once -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let ctx = document.getElementById('categoryChart').getContext('2d');
let categoryChart;

// Function to fetch data and update chart & total
function updateChart() {
    fetch('/data')
        .then(res => res.json())
        .then(data => {
            document.querySelector('h3').innerText = `Total Spent: $${data.total.toFixed(2)}`;
            if(categoryChart){
                categoryChart.data.labels = Object.keys(data.category_totals);
                categoryChart.data.datasets[0].data = Object.values(data.category_totals);
                categoryChart.update();
            } else {
                categoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.category_totals),
                        datasets: [{
                            label: 'Spending by Category ($)',
                            data: Object.values(data.category_totals),
                            backgroundColor: 'rgba(52, 152, 219, 0.5)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }
        });
}

// 1. Inline edit save
document.querySelectorAll(".save-btn").forEach(button => {
    button.addEventListener("click", () => {
        const id = button.dataset.id;
        const amount = document.querySelector(`.edit-amount[data-id='${id}']`).value;
        const category = document.querySelector(`.edit-category[data-id='${id}']`).value;

        fetch(`/update/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: amount, category: category })
        }).then(res => res.json())
          .then(data => { if(data.success) updateChart(); });
    });
});

// 2. Delete single expense
document.querySelectorAll(".delete-btn").forEach(button => {
    button.addEventListener("click", e => {
        e.preventDefault();
        const id = button.dataset.id;
        fetch(`/delete/${id}`).then(() => {
            button.closest("tr").remove();
            updateChart();
        });
    });
});

// 3. Delete all expenses
document.querySelector(".delete-all").addEventListener("click", e => {
    e.preventDefault();
    fetch('/delete_all').then(() => {
        document.querySelectorAll("table tbody tr").forEach(tr => tr.remove());
        updateChart();
    });
});

// 4. Initial chart load
updateChart();
</script>

</body>
</html>






